pipeline {
    agent any
    environment {
        dockerRepoName = "10.182.0.18:8121/nexus-docker/spring-app"
        registryCredential = "dockerCred"
        registryUrl = "http://10.182.0.18:8121"
    }
    stages {
        stage('Static Code Analysis') {
            steps {
                withSonarQubeEnv(installationName: 'SONAR4.7', credentialsId: 'MySonarToken') {
                    sh '''
                        chmod +x gradlew
                        ./gradlew sonarqube
                    '''
                }
            }
        }

        stage('Quality Gate') {
            steps {
                timeout(time: 10, unit: 'MINUTES') {
                waitForQualityGate abortPipeline: true
              }
            }
        }

        stage('Docker Build') {
            steps {
                script {
                    dockerImage = docker.build dockerRepoName + ":V$BUILD_NUMBER"
                }
            }
        }

        stage('Docker Push') {
            steps {
                script {
                    docker.withRegistry(registryUrl,registryCredential) {
                        dockerImage.push("V$BUILD_NUMBER")
                    }
                }
            }
        }

        stage('Remove Unused Images') {
            steps {
                sh '''
                docker rmi $dockerRepoName:V$BUILD_NUMBER
                '''
                
            }
        }

        stage('Datree Validation') {
            steps {
                script {
                dir('kube-manifest/') {
                    withEnv(['DATREE_TOKEN=32b9a231-0c92-4724-ad9a-3f4a50fdae66']) {
                    sh 'helm datree test spring-app/'
                    }
                  }
                }
            }
        }

        stage('Push Helm Charts to Nexus') {
            steps {
                script {
                    dir('kube-manifest/') {
                        withCredentials([string(credentialsId: 'nexusPass', variable: 'NexusCred')]) {
                            sh '''
                                chartversion=$( helm show chart spring-app | grep version | cut -d: -f 2 | tr -d ' ' )
                                tar -czvf spring-app-$chartversion.tgz spring-app
                                curl -u admin:$NexusCred http://10.182.0.18:8081/repository/helm-hosted/ --upload-file spring-app-$chartversion.tgz -v
                                rm -rf spring-app-$chartversion.tgz spring-app
                            '''
                        }
                    } 
                }
            }
        }

        stage('Add Helm Repo') {
            agent {label 'K8CLUSTER'}
            steps {
                withCredentials([string(credentialsId: 'nexusPass', variable: 'NexusCred')]) {
                sh '''
                helm repo add helm-hosted http://10.182.0.18:8081/repository/helm-hosted/ --username admin --password $NexusCred
                helm repo update
                '''
                }
            }
        }

        stage('Deploy to Minikube with Helm'){
            agent {label 'K8CLUSTER'}
            steps {
                script {
                     dir('kube-manifest/') {
                          sh 'helm upgrade --install myspringapp --set image.repository="${dockerRepoName}" --set image.tag="V${BUILD_NUMBER}" helm-hosted/spring-app'
                    }
                }
            }
        }


    }
}


//kubectl create secret docker-registry regcred --docker-server=http://34.125.95.96:8121 --docker-username=admin --docker-password=admin --docker-email=email.com
